<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Escape Rooms | AI Mastery Bootcamp</title>
    <link rel="stylesheet" href="/css/global.css">
    <style>
        body {
            padding: 80px 20px 40px;
            min-height: 100vh;
        }

        .game-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 30px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .game-title h1 {
            font-size: 1.5rem;
            margin: 0;
        }

        .game-stats {
            display: flex;
            gap: 25px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--accent-purple);
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .room-select {
            max-width: 1000px;
            margin: 0 auto 40px;
        }

        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .room-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .room-card:hover {
            border-color: var(--accent-purple);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(157, 78, 221, 0.3);
        }

        .room-card.completed {
            border-color: var(--accent-green);
        }

        .room-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .room-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .room-difficulty {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .difficulty-beginner {
            background: var(--accent-green-dim);
            color: var(--accent-green);
        }

        .difficulty-intermediate {
            background: var(--accent-orange-dim);
            color: var(--accent-orange);
        }

        .difficulty-advanced {
            background: var(--accent-purple-dim);
            color: var(--accent-purple);
        }

        .room-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .room-status {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
        }

        .room-container {
            display: none;
            max-width: 900px;
            margin: 0 auto;
        }

        .room-container.active {
            display: block;
        }

        .story-panel {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            border: 2px solid var(--accent-purple);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
        }

        .story-panel::before {
            content: 'üîí';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5rem;
            background: var(--bg-primary);
            padding: 0 15px;
        }

        .story-text {
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-primary);
            margin-bottom: 20px;
            font-style: italic;
        }

        .task-text {
            background: var(--bg-elevated);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-purple);
            font-weight: 500;
        }

        .prompt-panel {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .prompt-label {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--accent-purple);
        }

        .prompt-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px var(--accent-purple-dim);
        }

        .char-count {
            text-align: right;
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .hint-panel {
            display: none;
            background: var(--accent-yellow-dim);
            border: 2px solid var(--accent-yellow);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .hint-panel.visible {
            display: block;
        }

        .hint-header {
            color: var(--accent-yellow);
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .results-panel {
            display: none;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .results-panel.visible {
            display: block;
        }

        .score-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            position: relative;
        }

        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        .score-label {
            font-size: 1rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .feedback-section {
            margin-top: 20px;
        }

        .feedback-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .feedback-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .perfect-example {
            background: var(--bg-elevated);
            border: 2px solid var(--accent-green);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .perfect-example h4 {
            color: var(--accent-green);
            margin-bottom: 10px;
        }

        .btn-back {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 200;
        }
    </style>
</head>
<body>
    <a href="/games" class="btn btn-secondary btn-back">‚Üê Back</a>

    <div class="game-header">
        <div class="game-title">
            <span style="font-size: 2rem;">üóùÔ∏è</span>
            <div>
                <h1>PROMPT ESCAPE ROOMS</h1>
                <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">Craft the perfect prompt to unlock each room</p>
            </div>
        </div>
        <div class="game-stats">
            <div class="stat">
                <div class="stat-value" id="rooms-completed">0</div>
                <div class="stat-label">Rooms</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="total-xp">0</div>
                <div class="stat-label">XP</div>
            </div>
        </div>
    </div>

    <!-- Room Selection -->
    <div class="room-select" id="room-select">
        <h2 class="text-center">Choose Your Challenge</h2>
        <p class="text-center" style="color: var(--text-secondary); margin-bottom: 30px;">
            Each room tests a different aspect of prompt engineering. Can you escape them all?
        </p>
        <div class="rooms-grid" id="rooms-grid">
            <!-- Populated dynamically -->
        </div>
    </div>

    <!-- Room Challenge -->
    <div class="room-container" id="room-container">
        <button class="btn btn-secondary" style="margin-bottom: 20px;" onclick="backToRooms()">‚Üê Back to Rooms</button>

        <div class="story-panel">
            <div class="story-text" id="story-text"></div>
            <div class="task-text" id="task-text"></div>
        </div>

        <div class="prompt-panel">
            <div class="prompt-label">‚úçÔ∏è Craft Your Prompt:</div>
            <textarea id="prompt-input" class="prompt-textarea" placeholder="Type your prompt here..."></textarea>
            <div class="char-count">
                <span id="char-count">0</span> / <span id="max-chars">400</span> characters
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="submitPrompt()">üîì Attempt Escape</button>
            <button class="btn btn-secondary" onclick="showHint()">üí° Request Hint (-10 points)</button>
        </div>

        <div class="hint-panel" id="hint-panel">
            <div class="hint-header">
                <span>üí°</span>
                <span>Hint</span>
            </div>
            <p id="hint-text"></p>
        </div>

        <div class="results-panel" id="results-panel">
            <div class="score-display">
                <div class="score-circle">
                    <svg width="150" height="150">
                        <circle cx="75" cy="75" r="70" fill="none" stroke="var(--bg-secondary)" stroke-width="8"/>
                        <circle id="score-circle" cx="75" cy="75" r="70" fill="none" stroke="url(#gradient)" stroke-width="8" stroke-linecap="round" transform="rotate(-90 75 75)" stroke-dasharray="440" stroke-dashoffset="440"/>
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="var(--accent-purple)"/>
                                <stop offset="100%" stop-color="var(--accent-pink)"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <div class="score-value" id="score-value">0</div>
                </div>
                <div class="score-label" id="score-label">Score</div>
            </div>

            <div class="feedback-section" id="feedback-section">
                <!-- Populated dynamically -->
            </div>

            <div class="perfect-example" id="perfect-example" style="display: none;">
                <h4>üìù Example of an Excellent Prompt:</h4>
                <p id="perfect-text" style="color: var(--text-secondary);"></p>
            </div>

            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="backToRooms()">Back to Rooms</button>
                <button class="btn btn-secondary" onclick="tryAgain()">Try Again</button>
            </div>
        </div>
    </div>

    <script src="/js/game-engine.js"></script>
    <script src="/js/progress-tracker.js"></script>
    <script>
        let rooms = [];
        let currentRoom = null;
        let hintsUsed = 0;
        let currentHintIndex = 0;
        let completedRooms = new Set();

        // Load rooms data
        fetch('/data/scenarios/escape-rooms.json')
            .then(res => res.json())
            .then(data => {
                rooms = data.rooms;
                loadProgress();
                renderRoomGrid();
            });

        function loadProgress() {
            const saved = localStorage.getItem('escape-rooms-progress');
            if (saved) {
                completedRooms = new Set(JSON.parse(saved));
                updateStats();
            }
        }

        function saveProgress() {
            localStorage.setItem('escape-rooms-progress', JSON.stringify([...completedRooms]));
            updateStats();
        }

        function updateStats() {
            document.getElementById('rooms-completed').textContent = completedRooms.size;
        }

        function renderRoomGrid() {
            const grid = document.getElementById('rooms-grid');
            grid.innerHTML = rooms.map(room => {
                const completed = completedRooms.has(room.id);
                const diffClass = `difficulty-${room.difficulty.toLowerCase()}`;
                
                return `
                    <div class="room-card ${completed ? 'completed' : ''}" onclick="enterRoom('${room.id}')">
                        <div class="room-status">${completed ? '‚úÖ' : 'üîí'}</div>
                        <div class="room-icon">üö™</div>
                        <div class="room-difficulty ${diffClass}">${room.difficulty}</div>
                        <div class="room-name">${room.name}</div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 10px 0 0 0;">
                            ${completed ? 'Escaped! ‚ú®' : `+${room.xpReward} XP`}
                        </p>
                    </div>
                `;
            }).join('');
        }

        function enterRoom(roomId) {
            currentRoom = rooms.find(r => r.id === roomId);
            hintsUsed = 0;
            currentHintIndex = 0;
            
            document.getElementById('room-select').style.display = 'none';
            document.getElementById('room-container').classList.add('active');
            
            document.getElementById('story-text').textContent = currentRoom.story;
            document.getElementById('task-text').innerHTML = `<strong>Your Mission:</strong> ${currentRoom.task}`;
            document.getElementById('prompt-input').value = '';
            document.getElementById('char-count').textContent = '0';
            document.getElementById('max-chars').textContent = currentRoom.evaluationCriteria.maxLength;
            document.getElementById('hint-panel').classList.remove('visible');
            document.getElementById('results-panel').classList.remove('visible');
            
            // Character counter
            const textarea = document.getElementById('prompt-input');
            textarea.addEventListener('input', () => {
                document.getElementById('char-count').textContent = textarea.value.length;
            });
        }

        function backToRooms() {
            document.getElementById('room-select').style.display = 'block';
            document.getElementById('room-container').classList.remove('active');
            currentRoom = null;
        }

        function showHint() {
            if (currentHintIndex < currentRoom.hints.length) {
                document.getElementById('hint-text').textContent = currentRoom.hints[currentHintIndex];
                document.getElementById('hint-panel').classList.add('visible');
                currentHintIndex++;
                hintsUsed++;
            }
        }

        function submitPrompt() {
            const prompt = document.getElementById('prompt-input').value.trim();
            
            if (!prompt) {
                alert('Please write a prompt first!');
                return;
            }
            
            const score = evaluatePrompt(prompt);
            showResults(score);
        }

        function evaluatePrompt(prompt) {
            const criteria = currentRoom.evaluationCriteria;
            let score = 0;
            let feedback = [];
            
            // Length check (15 points)
            if (prompt.length >= criteria.minLength && prompt.length <= criteria.maxLength) {
                score += 15;
                feedback.push({ icon: '‚úÖ', text: 'Good length - detailed but concise', positive: true });
            } else if (prompt.length < criteria.minLength) {
                feedback.push({ icon: '‚ö†Ô∏è', text: 'Prompt is too short - add more detail and context', positive: false });
            } else {
                feedback.push({ icon: '‚ö†Ô∏è', text: 'Prompt is too long - try to be more concise', positive: false });
            }
            
            // Keywords check (35 points)
            const promptLower = prompt.toLowerCase();
            const foundKeywords = criteria.keywords.filter(kw => promptLower.includes(kw.toLowerCase()));
            const keywordScore = Math.floor((foundKeywords.length / criteria.keywords.length) * 35);
            score += keywordScore;
            
            if (keywordScore >= 25) {
                feedback.push({ icon: '‚úÖ', text: `Great keyword coverage (${foundKeywords.length}/${criteria.keywords.length} key concepts)`, positive: true });
            } else {
                feedback.push({ icon: '‚ö†Ô∏è', text: `Missing key concepts - found ${foundKeywords.length}/${criteria.keywords.length}`, positive: false });
            }
            
            // Bonus keywords (20 points)
            const foundBonus = criteria.bonusKeywords.filter(kw => promptLower.includes(kw.toLowerCase()));
            const bonusScore = Math.floor((foundBonus.length / criteria.bonusKeywords.length) * 20);
            score += bonusScore;
            
            if (bonusScore > 10) {
                feedback.push({ icon: 'üåü', text: `Excellent depth - mentioned ${foundBonus.length} advanced concepts`, positive: true });
            }
            
            // Anti-patterns check (-10 points each)
            const foundAntiPatterns = criteria.antiPatterns.filter(ap => promptLower.includes(ap.toLowerCase()));
            score -= foundAntiPatterns.length * 10;
            
            if (foundAntiPatterns.length > 0) {
                feedback.push({ icon: '‚ùå', text: `Avoid phrases like: ${foundAntiPatterns.join(', ')}`, positive: false });
            } else {
                score += 15;
                feedback.push({ icon: '‚úÖ', text: 'No anti-patterns detected - good prompting style!', positive: true });
            }
            
            // Structure bonus (15 points)
            const hasStructure = prompt.includes('1)') || prompt.includes('2)') || prompt.includes('-') || prompt.includes('‚Ä¢');
            if (hasStructure) {
                score += 15;
                feedback.push({ icon: '‚úÖ', text: 'Well-structured with numbered points or bullets', positive: true });
            } else {
                feedback.push({ icon: 'üí°', text: 'Consider structuring your prompt with numbered points', positive: false });
            }
            
            // Hint penalty
            score -= hintsUsed * 10;
            if (hintsUsed > 0) {
                feedback.push({ icon: '‚ÑπÔ∏è', text: `Hints used: -${hintsUsed * 10} points`, positive: false });
            }
            
            // Cap score
            score = Math.max(0, Math.min(100, score));
            
            return { score, feedback, passed: score >= currentRoom.passingScore };
        }

        function showResults(result) {
            const panel = document.getElementById('results-panel');
            const scoreCircle = document.getElementById('score-circle');
            const scoreValue = document.getElementById('score-value');
            const scoreLabel = document.getElementById('score-label');
            const feedbackSection = document.getElementById('feedback-section');
            
            // Animate score
            const circumference = 2 * Math.PI * 70;
            const offset = circumference - (result.score / 100) * circumference;
            scoreCircle.style.strokeDashoffset = offset;
            
            scoreValue.textContent = result.score;
            scoreValue.style.color = result.passed ? 'var(--accent-green)' : 'var(--accent-orange)';
            scoreLabel.textContent = result.passed ? 'ESCAPED!' : 'KEEP TRYING';
            scoreLabel.style.color = result.passed ? 'var(--accent-green)' : 'var(--accent-orange)';
            
            // Render feedback
            feedbackSection.innerHTML = result.feedback.map(item => `
                <div class="feedback-item">
                    <div class="feedback-icon">${item.icon}</div>
                    <div style="flex: 1;">${item.text}</div>
                </div>
            `).join('');
            
            // Show perfect example if didn't pass
            if (!result.passed) {
                document.getElementById('perfect-example').style.display = 'block';
                document.getElementById('perfect-text').textContent = currentRoom.perfectExample;
            } else {
                document.getElementById('perfect-example').style.display = 'none';
            }
            
            panel.classList.add('visible');
            
            // Award XP and mark complete if passed
            if (result.passed && !completedRooms.has(currentRoom.id)) {
                completedRooms.add(currentRoom.id);
                saveProgress();
                GameEngine.awardXP(currentRoom.xpReward, `Escaped: ${currentRoom.name}`);
                
                // Check for achievement
                if (completedRooms.size === rooms.length) {
                    GameEngine.unlockAchievement('escape-artist');
                    GameEngine.completeGame('prompt-escape-rooms', completedRooms.size * 100);
                }
                
                renderRoomGrid();
            }
        }

        function tryAgain() {
            document.getElementById('results-panel').classList.remove('visible');
            document.getElementById('prompt-input').value = '';
            document.getElementById('char-count').textContent = '0';
        }
    </script>
</body>
</html>
